<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XamIQ | Master Admin Console</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .admin-card { background: white; border-radius: 24px; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
        .admin-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 600; outline: none; margin-bottom: 12px; transition: 0.2s; }
        .admin-input:focus { border-color: #f97316; box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, serverTimestamp, updateDoc, getDoc, where } from 'firebase/firestore';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'firebase/auth';
        import { ShieldCheck, LayoutDashboard, BookOpen, Image, Bell, Users, MessageSquare, Plus, Trash2, LogOut, Send, Save, Edit3, Loader2 } from 'lucide-react';

        const firebaseConfig = {
          apiKey: "AIzaSyA2iHrUt8_xxvB2m8-LftaE9fTjVj_E_3Y",
          authDomain: "banty-live.firebaseapp.com",
          projectId: "banty-live",
          storageBucket: "banty-live.firebasestorage.app",
          messagingSenderId: "435477036444",
          appId: "1:435477036444:web:3858e75d51aacba1269c59"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(null);
            const [tab, setTab] = useState('dashboard');
            const [stats, setStats] = useState({u:0, c:0, b:0, n:0});

            useEffect(() => {
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        const d = await getDoc(doc(db, "users", u.uid));
                        if (d.exists() && d.data().role === 'admin') {
                            setIsAdmin(true);
                        } else {
                            setIsAdmin(false);
                        }
                    } else {
                        setUser(null);
                        setIsAdmin(null);
                    }
                });
            }, []);

            useEffect(() => {
                if(!isAdmin) return;
                onSnapshot(collection(db, "users"), s => setStats(v => ({...v, u: s.size})));
                onSnapshot(collection(db, "courses"), s => setStats(v => ({...v, c: s.size})));
                onSnapshot(collection(db, "banners"), s => setStats(v => ({...v, b: s.size})));
                onSnapshot(collection(db, "notifications"), s => setStats(v => ({...v, n: s.size})));
            }, [isAdmin]);

            const login = () => signInWithPopup(auth, new GoogleAuthProvider());

            if (user && isAdmin === false) return (
                <div className="h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-red-100 text-red-600 p-8 rounded-full mb-6"><ShieldCheck size={50}/></div>
                    <h1 className="text-2xl font-black mb-2 uppercase">Access Denied</h1>
                    <p className="text-slate-400 font-bold mb-6">Aapka Gmail "{user.email}" admin nahi hai.</p>
                    <button onClick={() => signOut(auth)} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold uppercase text-xs">Login with Other Account</button>
                </div>
            );

            if (!user) return (
                <div className="h-screen flex items-center justify-center p-6 bg-slate-900">
                    <div className="max-w-md w-full bg-white p-10 rounded-[2.5rem] text-center shadow-2xl">
                        <div className="w-20 h-20 bg-orange-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-orange-200"><ShieldCheck size={40} /></div>
                        <h1 className="text-2xl font-black mb-2 italic">XamIQ <span className="text-orange-600">Admin</span></h1>
                        <p className="text-slate-400 text-xs mb-8 font-bold uppercase tracking-widest">Master Key Access Only</p>
                        <button onClick={login} className="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-slate-50 transition-all">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"/>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex">
                    <div className="w-72 bg-slate-950 p-6 flex flex-col fixed h-full">
                        <div className="mb-10 px-4 pt-4 text-white font-black text-2xl italic">XAM<span className="text-orange-600">IQ</span></div>
                        <nav className="flex-1 space-y-2 text-slate-400">
                            {['dashboard','courses','banners','notifications','chats'].map(t => (
                                <button key={t} onClick={()=>setTab(t)} className={`w-full flex items-center gap-3 px-6 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all ${tab===t?'bg-orange-600 text-white shadow-lg shadow-orange-600/20':'hover:bg-white/5'}`}>
                                    {t==='dashboard' && <LayoutDashboard size={18}/>}
                                    {t==='courses' && <BookOpen size={18}/>}
                                    {t==='banners' && <Image size={18}/>}
                                    {t==='notifications' && <Bell size={18}/>}
                                    {t==='chats' && <MessageSquare size={18}/>}
                                    {t}
                                </button>
                            ))}
                        </nav>
                        <button onClick={()=>signOut(auth)} className="flex items-center gap-3 p-4 text-red-400 font-black text-xs mt-auto"><LogOut size={18}/> Shutdown</button>
                    </div>

                    <div className="flex-1 ml-72">
                        <header className="h-20 bg-white border-b px-10 flex items-center justify-between sticky top-0 z-50">
                            <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">Secure / {tab}</span>
                            <div className="flex items-center gap-4">
                                <div className="text-right"><p className="text-[10px] font-black text-slate-900">{user.displayName}</p><p className="text-[8px] font-black text-green-500 uppercase tracking-widest">Admin Mode</p></div>
                                <img src={user.photoURL} className="w-10 h-10 rounded-2xl border" />
                            </div>
                        </header>

                        <div className="p-10">
                            {tab === 'dashboard' && <div className="grid grid-cols-4 gap-6">
                                <Card l="Students" v={stats.u} i={Users} c="bg-blue-600" />
                                <Card l="Courses" v={stats.c} i={BookOpen} c="bg-orange-600" />
                                <Card l="Banners" v={stats.b} i={Image} c="bg-purple-600" />
                                <Card l="Alerts" v={stats.n} i={Bell} c="bg-rose-600" />
                            </div>}
                            {tab === 'chats' && <ChatSystem db={db} />}
                            {['courses', 'banners', 'notifications'].includes(tab) && <Manager type={tab} db={db} />}
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({l,v,i:Icon,c}) => (
            <div className="admin-card p-8"><div className={`${c} w-12 h-12 rounded-2xl flex items-center justify-center text-white mb-6 shadow-lg shadow-slate-100`}><Icon size={24}/></div><p className="text-slate-400 text-[10px] font-black uppercase tracking-widest">{l}</p><h3 className="text-4xl font-black text-slate-900 mt-2">{v}</h3></div>
        );

        const Manager = ({ type, db }) => {
            const [items, setItems] = useState([]);
            const [form, setForm] = useState({});
            const [editId, setEditId] = useState(null);

            useEffect(() => {
                return onSnapshot(query(collection(db, type), orderBy("createdAt", "desc")), s => setItems(s.docs.map(d=>({id:d.id, ...d.data()}))));
            }, [type]);

            const save = async () => {
                const data = { ...form, updatedAt: serverTimestamp() };
                if(!editId) { data.createdAt = serverTimestamp(); await addDoc(collection(db, type), data); }
                else { await updateDoc(doc(db, type, editId), data); }
                setForm({}); setEditId(null);
            };

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="admin-card p-10">
                        <h2 className="text-lg font-black mb-8 uppercase flex items-center gap-3">Manage {type}</h2>
                        <div className="grid grid-cols-2 gap-4">
                            {type === 'courses' ? (
                                <><input className="admin-input" placeholder="Title" value={form.title||''} onChange={e=>setForm({...form, title:e.target.value})}/><input className="admin-input" placeholder="Instructor" value={form.instructor||''} onChange={e=>setForm({...form, instructor:e.target.value})}/><input className="admin-input" placeholder="Thumbnail URL" value={form.thumbnail||''} onChange={e=>setForm({...form, thumbnail:e.target.value})}/><input className="admin-input" placeholder="Link" value={form.link||''} onChange={e=>setForm({...form, link:e.target.value})}/></>
                            ) : type === 'banners' ? (
                                <><input className="admin-input" placeholder="Image URL" value={form.imageUrl||''} onChange={e=>setForm({...form, imageUrl:e.target.value})}/><input className="admin-input" placeholder="Link" value={form.link||''} onChange={e=>setForm({...form, link:e.target.value})}/></>
                            ) : <input className="admin-input col-span-2" placeholder="Message content..." value={form.message||''} onChange={e=>setForm({...form, message:e.target.value})}/>}
                        </div>
                        <button onClick={save} className="mt-8 bg-orange-600 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl">Save & Update</button>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {items.map(it => (
                            <div key={it.id} className="admin-card p-4 flex items-center gap-5 hover:border-orange-200 transition-all">
                                {(it.thumbnail || it.imageUrl) && <img src={it.thumbnail || it.imageUrl} className="w-16 h-16 rounded-2xl object-cover shadow-sm" />}
                                <div className="flex-1 min-w-0 font-bold text-sm text-slate-800 truncate">{it.title || it.message}</div>
                                <button onClick={()=>{setEditId(it.id); setForm(it)}} className="p-3 text-slate-300 hover:text-orange-600"><Edit3 size={18}/></button>
                                <button onClick={()=>confirm("Delete?") && deleteDoc(doc(db, type, it.id))} className="p-3 text-red-400 hover:bg-red-50 rounded-xl"><Trash2 size={18}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ChatSystem = ({ db }) => {
            const [users, setUsers] = useState([]);
            const [sel, setSel] = useState(null);
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState("");

            useEffect(() => { onSnapshot(collection(db, "users"), s => setUsers(s.docs.map(d=>({id:d.id, ...d.data()})))); }, []);
            useEffect(() => { if(!sel) return; return onSnapshot(query(collection(db, "chats"), where("userId", "==", sel.id), orderBy("timestamp", "asc")), s => setMsgs(s.docs.map(d=>({id:d.id, ...d.data()})))); }, [sel]);

            const send = async () => {
                if(!txt.trim()) return;
                const m = txt; setTxt("");
                await addDoc(collection(db, "chats"), { userId: sel.id, message: m, sender: 'admin', timestamp: serverTimestamp() });
            };

            return (
                <div className="admin-card h-[70vh] flex overflow-hidden">
                    <div className="w-72 border-r border-slate-100 overflow-y-auto bg-slate-50/50">
                        {users.map(u => (
                            <button key={u.id} onClick={()=>setSel(u)} className={`w-full p-6 text-left border-b flex items-center gap-4 transition-all ${sel?.id === u.id ? 'bg-white shadow-sm' : ''}`}>
                                <img src={u.avatar} className="w-10 h-10 rounded-full border" />
                                <div className="truncate font-black text-[10px] uppercase text-slate-500">{u.name}</div>
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 flex flex-col bg-white">
                        {sel ? (
                            <><div className="flex-1 p-8 overflow-y-auto space-y-4">{msgs.map(m => <div key={m.id} className={`flex ${m.sender==='admin'?'justify-end':'justify-start'}`}><div className={`max-w-[75%] p-4 rounded-2xl text-xs font-bold shadow-sm ${m.sender==='admin'?'bg-slate-900 text-white rounded-br-none':'bg-slate-100 text-slate-700 rounded-tl-none'}`}>{m.message}</div></div>)}</div>
                            <div className="p-6 border-t flex gap-4"><input className="admin-input !mb-0" placeholder="Type reply..." value={txt} onChange={e=>setTxt(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} /><button onClick={send} className="bg-orange-600 text-white p-4 rounded-xl"><Send size={20}/></button></div></>
                        ) : <div className="m-auto opacity-10 font-black uppercase tracking-widest text-xs">Select Student</div>}
                    </div>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>